library(dplyr)
library(Strategus)

# Cohorts to keep for TreatmentPatterns
# Uncomment after testing
cohortsToKeep <- c(
  2,   # Newly Diagnosed T2DM (3 Years Continuous Observation): target
  11,  # Prevalent T2DM (3 Years Continuous Observation): target
  110, # DR Screening, In Office
  120, # DR Screening, Telemedicine
  130  # DR Screening, AI
)

# Time-at-risks (TARs) for the outcomes of interest in your study
timeAtRisks <- tibble(
  label = c("Year 1", "Year 2", "Year 3", "Year 4"),
  riskWindowStart  = c(0, 365, 730, 1095),   # CONFIRM start at 0
  startAnchor = c("cohort start"),
  riskWindowEnd  = c(365, 730, 1095, 1460),
  endAnchor = c("cohort end")
)

studyStartDate <- '20210101' #YYYYMMDD
studyEndDate <- '20241231'   #YYYYMMDD

# Some of the settings require study dates with hyphens
studyStartDateWithHyphens <- gsub("(\\d{4})(\\d{2})(\\d{2})", "\\1-\\2-\\3", studyStartDate)
studyEndDateWithHyphens <- gsub("(\\d{4})(\\d{2})(\\d{2})", "\\1-\\2-\\3", studyEndDate)


# Shared Resources -------------------------------------------------------------
# NOTE: Generated by DownloadCohorts.R
cohortDefinitionSetLimited <- CohortGenerator::getCohortDefinitionSet(
  settingsFileName = "inst/cohorts.csv",
  jsonFolder = "inst/cohorts",
  sqlFolder = "inst/sql/sql_server"
) |> 
  filter(
    cohortId %in% cohortsToKeep
  ) 

if (any(duplicated(cohortDefinitionSetLimited$cohortId))) {
  stop("*** Error: duplicate cohort IDs found ***")
}

# Create some data frames to hold the cohorts we'll use in each analysis ---------------

# CohortGeneratorModule --------------------------------------------------------
cgModuleSettingsCreator <- CohortGeneratorModule$new()
cohortDefinitionShared <- cgModuleSettingsCreator$createCohortSharedResourceSpecifications(cohortDefinitionSetLimited)

cohortGeneratorModuleSpecifications <- cgModuleSettingsCreator$createModuleSpecifications(
  generateStats = TRUE
)

# TreamentPatternsModule Settings ---------------------------------
tpSettingsCreator <- Strategus::TreatmentPatternsModule$new()

# We need four specifications for the treatment patterns module, one for each indication cohort.
tpTargetCohorts <- cohortDefinitionSetLimited |>
  mutate(
    type = case_when(
      cohortId < 100 ~ "target",
      cohortId >= 100 & cohortId < 200 ~ "event"
    )
  ) |>
  filter(cohortId %in% cohortsToKeep) |> 
  select(
    cohortId,
    cohortName,
    type
  ) 

treatmentPatternsModuleSpecifications <- tpSettingsCreator$createModuleSpecifications(
  cohorts = tpTargetCohorts,
  includeTreatments = "startDate",
  indexDateOffset = 0,
  minEraDuration = 0,
  splitEventCohorts = NULL,
  splitTime = NULL,
  eraCollapseSize = 0,
  combinationWindow = 0,
  minPostCombinationDuration = 0,
  filterTreatments = "Changes",
  maxPathLength = 5
)

# Create the analysis specifications ------------------------------------------
analysisSpecifications <- Strategus::createEmptyAnalysisSpecificiations() |>
  Strategus::addSharedResources(cohortDefinitionShared) |> 
  Strategus::addModuleSpecifications(cohortGeneratorModuleSpecifications) |>
  Strategus::addModuleSpecifications(treatmentPatternsModuleSpecifications)

ParallelLogger::saveSettingsToJson(
  analysisSpecifications, 
  file.path("inst", "drScreeningStudyAnalysisSpecificationTreatmentPatterns.json")
)